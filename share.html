<!DOCTYPE html><html lang="de"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Snackbook Share</title>
<style>body{font:14px system-ui;padding:24px} .muted{color:#666}</style>
</head><body>
<h1>Wird gespeichertâ€¦</h1>
<p class="muted">Falls nichts passiert, <a id="open" href="/">hier Ã¶ffnen</a>.</p>
<script>
;(async () => {
  // tiny localForage-like helpers
  const lf = {
    get:k=>Promise.resolve(JSON.parse(localStorage.getItem(k)||'null')),
    set:(k,v)=>Promise.resolve(localStorage.setItem(k,JSON.stringify(v)))
  };
  const DB='recipes', uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);

  const p = new URLSearchParams(location.search);

  // 1) Rohwerte aus GET
  let title = p.get('title') || '';
  let text  = p.get('text')  || '';
  let url   = p.get('url')   || '';

  // 2) Falls IG nur 'text' schickt, extrahiere die 1. URL daraus
  if (!url && text) {
    const m = text.match(/https?:\/\/[^\s)]+/i);
    if (m) url = m[0];
  }

  // 3) Als Fallback: nichts gekommen â†’ zurÃ¼ck
  if (!title && !text && !url) {
    location.href = '/'; return;
  }

  // 4) Versuch: Server-Extractor (holt OG-Daten/Kaption)
  let rec = null;
  if (url) {
    try {
      const r = await fetch('/.netlify/functions/extract?url=' + encodeURIComponent(url), {
        headers:{'Accept':'application/json'}
      });
      const data = await r.json();
      // Minimaler Record mit sinnvollen Defaults
      rec = {
        id: uid(),
        title: (data.title || title || text || url || 'Import').trim(),
        image: data.image || '',
        ingredients: data.ingredients || [],
        steps: data.steps || [],
        tags: (data.tags && data.tags.length ? data.tags : ['Import']),
        source: url,
        createdAt: Date.now(),
        kcal: data.macros?.kcal ?? null,
        protein: data.macros?.protein ?? null,
        carbs: data.macros?.carbs ?? null,
        fat: data.macros?.fat ?? null,
        notes: data.caption || data.notes || ''
      };
    } catch(e) {
      // fÃ¤llt unten auf Link-only zurÃ¼ck
    }
  }

  // 5) Fallback: nur Link/Title speichern
  if (!rec) {
    rec = {
      id: uid(),
      title: (title || text || url || 'Import').trim(),
      image: '',
      ingredients: [],
      steps: [],
      tags: ['Import'],
      source: url || '',
      createdAt: Date.now(),
      notes: ''
    };
  }

  // 6) Speichern & Ã¶ffnen
  const list = (await lf.get(DB)) || [];
  list.unshift(rec);
  await lf.set(DB, list);
  location.href = '/?open='+encodeURIComponent(rec.id);
})();
</script>
</body></html>

