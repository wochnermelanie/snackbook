<!DOCTYPE html><html lang="de"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Snackbook Share</title>
<style>body{font:14px system-ui;padding:24px} .muted{color:#666}</style>
</head><body>
<h1>Wird gespeichert…</h1>
<p class="muted">Falls nichts passiert, <a id="open" href="/">hier öffnen</a>.</p>
<script>
(async () => {
  const lf={get:k=>Promise.resolve(JSON.parse(localStorage.getItem(k)||'null')),set:(k,v)=>Promise.resolve(localStorage.setItem(k,JSON.stringify(v)))};
  const DB='recipes', uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
  const save=async (payload)=>{
    let {title='',text='',url='',image=''}=payload||{};
    if(url){
      try{
        const r=await fetch('/.netlify/functions/extract',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})});
        const d=await r.json();
        const rec={id:uid(),title:d.title||title||url||'Import',image:d.image||image||'',ingredients:d.ingredients||[],steps:d.steps||[],tags:d.tags||[],source:url,createdAt:Date.now(),kcal:d.macros?.kcal??null,protein:d.macros?.protein??null,carbs:d.macros?.carbs??null,fat:d.macros?.fat??null,notes:''};
        const list=(await lf.get(DB))||[];list.unshift(rec);await lf.set(DB,list);location.href='/?open='+encodeURIComponent(rec.id);return;
      }catch(e){}
    }
    const rec={id:uid(),title:title||text||url||'Import',image:'',ingredients:[],steps:[],tags:['Import'],source:url||'',createdAt:Date.now(),notes:text||''};
    const list=(await lf.get(DB))||[];list.unshift(rec);await lf.set(DB,list);location.href='/?open='+encodeURIComponent(rec.id);
  };

  // 1) POST Share Target (installed PWA)
  if('launchQueue'in window && 'LaunchParams'in window){
    launchQueue.setConsumer(async params=>{
      const data={title:params?.title||'',text:params?.text||'',url:params?.url||''};
      if(params?.files?.length){
        try{const f=await params.files[0].getFile();data.image=URL.createObjectURL(f);}catch{}
      }
      await save(data);
    });
  }

  // 2) Fallback: GET-Query (web share / desktop)
  const q=new URLSearchParams(location.search);
  const hasQ=[...q.keys()].some(k=>['title','text','url'].includes(k));
  if(hasQ){await save({title:q.get('title')||'',text:q.get('text')||'',url:q.get('url')||''});}
})();
</script>
</body></html>
